
{% extends "base.html" %}
{#{% block title %}Location View {{ location.PointID }}{% endblock %}#}
{% block head %}
    {{ super() }}
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>

    <script src="https://code.jquery.com/jquery-3.4.1.js"
            integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
            crossorigin="anonymous"></script>

{#    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">#}
    <style>
        body { margin: 0; padding: 0; }

        #map {height: 80vh}
        #statstable {
            {#position: absolute; top: 0; left: 0;#}

            padding: 10px; background: rgba(38, 191, 89, 0.5)
        }
        #menu { position: relative;
                float: right;
                z-index: 1;
                border: black 1px solid;
                background: antiquewhite;
                width: 20%;
                margin: 5px;
                padding: 5px;}

        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
            width: 120px;
            height: 120px;
            margin: -76px 0 0 -76px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
            display: none;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add animation to "page content" */
        .animate-bottom {
            position: relative;
            -webkit-animation-name: animatebottom;
            -webkit-animation-duration: 1s;
            animation-name: animatebottom;
            animation-duration: 1s
        }

        @-webkit-keyframes animatebottom {
            from { bottom:-100px; opacity:0 }
            to { bottom:0px; opacity:1 }
        }

        @keyframes animatebottom {
            from{ bottom:-100px; opacity:0 }
            to{ bottom:0; opacity:1 }
        }

    </style>

{% endblock %}

{% block content %}
    <div class="row">
        <div class="col">
            <h1 style="text-align: center">Healy Collaborative Groundwater Monitoring Network</h1>
            <p> The <a href="https://geoinfo.nmt.edu/resources/water/amp/home.html">Aquifer Mapping Program</a> is
                actively expanding the Healy Collaborative Groundwater Monitoring
                Network for New Mexico. Our primary focus is rural and under-monitored regions throughout the state.
                Our public groundwater level data is meant to benefit all water users â€” especially mutual domestic
                water systems, private domestic well owners, and water management decision-makers.
            </p>
            <p>
                Groundwater data is essential for tracking changes and making informed decisions about water
                management.
            </p>
            <p>
                Data can be accessed via this map or the <a href="/docs">API</a>
            </p>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div id="downloads" role="group" class="btn-group">
                <button class="btn btn-outline-primary" id='download_waterlevels'>Download WaterLevels CSV</button>
                <button class="btn btn-outline-primary" type="submit" formaction="/collabnet/locations/geojson">Download
                    Locations</button>
                <button class="btn btn-outline-primary" type="submit" formaction="/collabnet/locations/csv">Download Locations
                    CSV</button>
            </div>
            <div id="map">
                <div id="menu">
                    <div>
                        <input id="satellite-streets-v12" type="radio" name="rtoggle" value="satellite" checked="checked">
                        <!-- See a list of Mapbox-hosted public styles at -->
                        <!-- https://docs.mapbox.com/api/maps/styles/#mapbox-styles -->
                        <label for="satellite-streets-v12">satellite streets</label>
                    </div>
                    <div>
                        <input id="light-v11" type="radio" name="rtoggle" value="light">
                        <label for="light-v11">light</label>
                    </div>
                    <div>
                        <input id="dark-v11" type="radio" name="rtoggle" value="dark">
                        <label for="dark-v11">dark</label>
                    </div>
                    <div>
                        <input id="streets-v12" type="radio" name="rtoggle" value="streets">
                        <label for="streets-v12">streets</label>
                    </div>
                    <div>
                        <input id="outdoors-v12" type="radio" name="rtoggle" value="outdoors">
                        <label for="outdoors-v12">outdoors</label>
                    </div>
                </div>
            </div>


            <p style="font-size: small">Wells from current participants in the CGMN. Zoom in and click a well to see more
                information</p>

        </div>
        <div class="col">
            <div id="statstable">
            </div>
            <h2>Statistics</h2>
            <table>
                <tr>
                    <td>N. Wells</td><td>{{ nlocations }}</td>
                </tr>
            </table>
        </div>
    </div>
    <div style="height: 20px"></div>
    <div class="row">
        <div class="col">
            <h2><b>Want to get involved? Participation is Free</b></h2>
            <ul>
                <li>Data sharing is available to well owners, water systems, and small monitoring networks that are
                    willing and able to collect accurate water levels and would like to provide those measurements to
                    the Network.</li>
                <li>Well sharing is available to wells in high priority areas. The NMBGMR can equip suitable wells with
                    continuous monitoring devices or measure groundwater levels manually on an annual basis</li>
            </ul>
            Contact us to see if your well can be added to our monitoring network.
            <a href="mailto:nmbg-waterlevels@nmt.edu">nmbg-waterlevels@nmt.edu</a>
        </div>
    </div>


    <div id="loader"></div>



    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiamFrZXJvc3N3ZGkiLCJhIjoiY2s3M3ZneGl4MGhkMDNrcjlocmNuNWg4bCJ9.4r1DRDQ_ja0fV2nnmlVT0A';

        async function switchBasemap(map, styleID) {
            const { data: newStyle } = await fetch(
                `https://api.mapbox.com/styles/v1/${styleID}?access_token=${mapboxgl.accessToken}`
            );
            const currentStyle = map.getStyle();
            // ensure any sources from the current style are copied across to the new style
            newStyle.sources = Object.assign(
                {},
                currentStyle.sources,
                newStyle.sources
            );

            // find the index of where to insert our layers to retain in the new style
            let labelIndex = newStyle.layers.findIndex((el) => {
                return el.id == 'waterway-label';
            });

            // default to on top
            if (labelIndex === -1) {
                labelIndex = newStyle.layers.length;
            }
            const appLayers = currentStyle.layers.filter((el) => {
                // app layers are the layers to retain, and these are any layers which have a different source set
                return (
                    el.source &&
                    el.source != 'mapbox://mapbox.satellite' &&
                    el.source != 'mapbox' &&
                    el.source != 'composite'
                );
            });
            newStyle.layers = [
                ...newStyle.layers.slice(0, labelIndex),
                ...appLayers,
                ...newStyle.layers.slice(labelIndex, -1),
            ];
            map.setStyle(newStyle);
        }


        // TO MAKE THE MAP APPEAR YOU MUST
        // ADD YOUR ACCESS TOKEN FROM
        // https://account.mapbox.com
        const map = new mapboxgl.Map({
            container: 'map', // container ID
    // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
            style: 'mapbox://styles/mapbox/satellite-streets-v12', // style URL
            center: {{ center| tojson }}, // starting position [lng, lat]
            zoom: {{ zoom }} // starting zoom
        });

        const layerList = document.getElementById('menu');
        const inputs = layerList.getElementsByTagName('input');

        for (const input of inputs) {
            input.onclick = (layer) => {
                const layerId = layer.target.id;
                map.setStyle('mapbox://styles/mapbox/' + layerId);
            };
        }

        const popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false
        });

        map.on('mouseenter', 'wells', (e) => {
            map.getCanvas().style.cursor = 'pointer';

            // Copy coordinates array.
            const coordinates = e.features[0].geometry.coordinates.slice();

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            const description = e.features[0].properties.name
            popup.setLngLat(coordinates).setHTML(description).addTo(map);

        });
        
        map.on('mouseleave', 'wells', () => {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });
        map.on('click', 'wells', (e) => {
            const pointid = e.features[0].properties.name
            window.open('/locations/view/' + pointid, '_blank')
        });
        map.on('style.load',  () => {map.addSource('wells', {type: 'geojson',
            data: '{{ data_url }}' });

            map.addLayer({
                    id: 'wells',
                    type: 'circle',
                    source: 'wells',
                    paint: {
                        'circle-radius': 4,
                        'circle-color': '#B42222',
                        'circle-stroke-color': 'rgba(0,0,0,1)',
                        'circle-stroke-width': 1,
                    }
            });
          });
    </script>

    <script>
         // get the download water levels button element
        const downloadButton = document.querySelector('#download_waterlevels');
        // add event listener to the button
         downloadButton.addEventListener("click", async () => {
             document.getElementById("loader").style.display = "block";
             await fetch('/collabnet/waterlevels/csv').then(resp=>resp.blob()).then(blob=>{
                document.getElementById("loader").style.display = "none";

                 const url = window.URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.style.display = 'none';
                 a.href = url;

                 // the filename you want
                 a.download = 'waterlevels.csv';
                 document.body.appendChild(a);
                 a.click();
                 window.URL.revokeObjectURL(url);
             })
            }
         )

    </script>

{% endblock %}